{% extends 'templates/2-column-w-sponsors.html' %}

{% block titlecontent %}Song Suggestions{% endblock %}
{% block stylesheets %}
<style> 

   .up {
      width:25;
      height:23;
      background:url("/assets/music/upBright.png") no-repeat center;
   }
 
   .down {
      width:25;
      height:23;
      background:url("/assets/music/downBright.png") no-repeat center;
   }
 
   .up:disabled {
      background:url("/assets/music/upDull.png") no-repeat center;
   }
 
   .down:disabled {
      background:url("/assets/music/downDull.png") no-repeat center;
   }

</style> 

   <script type="text/javascript">
      function setVisibility(id, up, none, down) {
         $("#" + id + "_up").attr("disabled", up);
         $("#" + id + "_none").attr("disabled", none);
         $("#" + id + "_down").attr("disabled", down);
      }

      function toB(val) {
         if (val == "True") {
            return true
         } else {
            return false
         }
      }

      function voteSong(song_id, vote_method) {

         // set up a loading indicator next to the votes
         imgContent = "<img src='/assets/music/loading_animation_small.gif' />";
         $("#votes_" + song_id + "_loading").html(imgContent);

         setVisibility(song_id, true, true, true);


         //added this to for csrf token
         $.ajaxSetup({ 
           beforeSend: function(xhr, settings) {
               function getCookie(name) {
                   var cookieValue = null;
                   if (document.cookie && document.cookie != '') {
                       var cookies = document.cookie.split(';');
                       for (var i = 0; i < cookies.length; i++) {
                           var cookie = jQuery.trim(cookies[i]);
                           // Does this cookie string begin with the name we want?
                       if (cookie.substring(0, name.length + 1) == (name + '=')) {
                           cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                           break;
                       }
                   }
               }
               return cookieValue;
               }
               if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
                   // Only send the token to relative URLs i.e. locally.
                   xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
               }
           } 
      });

         $.ajax({
            url: 'vote/',
            type: 'POST',
            data: ({'song_id': song_id, 'vote': vote_method}),
            dataType: 'text',
            success: function(data) {
               p = data.split(";")
               $("#votes_" + song_id).text(p[0]);
               $("#votes_" + song_id + "_loading").html('');
               setVisibility(song_id, toB(p[1]), toB(p[2]), toB(p[3]));
            },
            error: function(req, stat, e) {
               alert('Unfortunately, your vote was not successful! Please check your connection, and try again');
               $("#votes_" + song_id + "_loading").html('');
               setVisibility(song_id, false, false, false);
            }
            });
      };
</script>
{% endblock %}

{% block content %}{% spaceless %}

   


<h2 > 
   Soctail Night Song Suggestions
</h2>
<div id='content' class="well"> 
   <form method="POST" action="" />
   {% csrf_token %}
    <h3>Suggest a song</h3> 
    <table class="table table-bordered"> 
      <tr> 
         <th >Artist</td> 
         <th >Title</td> 
         <th >Do you have the song?</td> 
         <th >Notes</td> 
      </tr> 
 
      <tr> 
         <td><input type="text" name="artist" maxlength="40"/></td> 
         <td><input type="text" name="title" maxlength="40" /></td> 
         <td><input type="checkbox" name="hassong" /></td> 
         <td><input type="text" name="notes" maxlength="100"/></td> 
      </tr> 

      {% if submitted %}
      <tr><td colspan="4" align="center" style="font-style:italic">
            <div id="submitted">
               Your suggestion of {{ songdetails }} has been added, thanks!
            </div>
      </td></tr> 
      {% endif %}

   </table>
   <input type="submit" class="btn" name="Submit" value="Submit">
</form>
   

      {% if songs|length %}
   <h3>Current suggestions</h3> 
   <table cellpadding="4" class="table table-bordered" width="100%">  
      <thead>
      <tr> 
         <th align="center" width="22%">Artist</td> 
         <th align="center" width="33%">Title</td> 
         <th align="center" width="20%">Votes</td> 
         <th align="center" width="25%">Vote for this song</td> 
      </tr> 
      </thead>




   {% for f in songs %}
      <tr>
         <td>{{ f.song.artist }}</td>
         <td>{{ f.song.title }}</td>
         <td align="center"><span id="votes_{{f.song.id}}">{{ f.song.votes }}</span><span id="votes_{{f.song.id}}_loading"></span></td>
         <td colspan="2" align="center">


            <button id="{{f.song.id}}_up" {% if f.states.0 %} disabled="true" {% endif %} class="btn up" style="vertical-align:middle" onclick="voteSong({{f.song.id}}, 'up');"></button>&nbsp;&nbsp;
            <button class="btn" id="{{f.song.id}}_none"  {% if f.states.1 %} disabled="true" {% endif %}  onclick="voteSong({{f.song.id}}, 'none');">None</button>&nbsp;&nbsp;
            <button id="{{f.song.id}}_down" {% if f.states.2 %} disabled="true" {% endif %} class="btn down" style="vertical-align:middle" onclick="voteSong({{f.song.id}}, 'down');"></button> 
         </td>
      </tr>
   {% endfor %}
   {% endif %}

   <form method="POST" action="vote">
      
   </form>
   </table>
</div>

{% endspaceless %}{% endblock %}

